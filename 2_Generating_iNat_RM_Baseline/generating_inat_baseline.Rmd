---
title: "Generating baseline from iNat data to compare users"
author: "Biohack team 12"
date: "09/11/2021"
output: html_document
---


```{r}
#devtools::install_github('biologicalrecordscentre/recorderMetrics')

library(rinat)

library(adehabitatHR)
library(raster)
library(sp)
library(rgdal)
library(recorderMetrics)

library(dplyr)
library(purrr)

library(httr)
library(jsonlite)

library(sf)

#library(ggplot2)

```

## Get data

### Getting a sample of users


Provide information about how we download the data

Turn users into usernames

```{r}
#load users
recorded_by <- readLines("Getting_Random_Observers/data/spain_100obs_observers_2021-11-09_12-03.txt")

usernames <- c()

for (i in 1:length(recorded_by)){
  res = GET("https://api.inaturalist.org/v1/users/autocomplete",
    query = list(q = recorded_by[i]))
  
  data = fromJSON(rawToChar(res$content))
  
  if (nrow(data$results)>1) {
    print("multiple matches :S")
  } else if (nrow(data$results)==1) {
    print("one match good! :D")
    username <- data$results$login
    usernames <- append(usernames,username)
  } else {
    "no matches :("
  }
  Sys.sleep(1)
}

saveRDS(usernames,"2_Generating_iNat_RM_Baseline/data/usernames.rds")

```



### Get observations for users

Do get calls for each user

```{r}
usernames <- readRDS("2_Generating_iNat_RM_Baseline/data/usernames.rds")
for (i in 120:length(usernames)){
  
  #OLD VERSION using rinat package
  # print(i)
  # user_observations <- get_inat_obs_user(usernames[i],maxresults = 5000)
  # saveRDS(user_observations,paste0("2_Generating_iNat_RM_Baseline/data/user_obvs/observations_",usernames[i],".rds"))
  # Sys.sleep(1)
  
  #new approach using: https://api.inaturalist.org/v1/docs/#!/Observations/get_observations
  res = GET("https://api.inaturalist.org/v1/observations",
    query = list(user_id = recorded_by[i],
                 per_page = 190,
                 taxon_id = 47126,
                 search_on = "place",
                 q = "Spain"))
  
  data = fromJSON(rawToChar(res$content))
  data$results
  saveRDS(user_observations,paste0("2_Generating_iNat_RM_Baseline/data/user_obvs/observations_",usernames[i],".rds"))
  
}
```

Combine into one dataframe

```{r}
all_observations_raw <- paste0("2_Generating_iNat_RM_Baseline/data/user_obvs/",list.files(path = "2_Generating_iNat_RM_Baseline/data/user_obvs", pattern = ".rds")) %>%
  map(readRDS) %>% 
  bind_rows()

```

Format data ready for recorderMetrics

```{r}
all_observations_raw %>% str()

#get columns and rename
all_observations <- all_observations_raw %>% 
  select(id = id,
         recorder = user_login,
         species = scientific_name,
         date = datetime,
         long = longitude,
         lat = latitude) %>%
  mutate(date = as.Date(date)) %>%
  filter(!is.na(long))

#quick look at the data
all_observations %>% str()

# generate: km_sq by projecting to spanish national grid
xy <- all_observations %>% select(lat,long)

#make into spatial data frame, convert to sf, transform to spanish grid, get coordinates and round to nearest 1000
spdf <- SpatialPointsDataFrame(coords = xy, data = all_observations,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")) %>% 
  st_as_sf() %>% 
  st_transform(spdf,crs = 2062) %>% 
  st_coordinates() %>% 
  round(-3) # not rounding down

#add the column to the data frame
all_observations$km_sq <- paste0(coordinates[,1],",",coordinates[,2])

write.csv(all_observations,"2_Generating_iNat_RM_Baseline/data/observations/draft_data.csv")
```

## Metric-ify

### Plug into recorder metrics

```{r}

metrics_axes <- predictAxes(data = all_observations,
                            recorders  = unique(cit_sci_data$recorder)[1:10])




```












